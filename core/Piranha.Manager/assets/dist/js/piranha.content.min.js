Vue.component("content-nav",{props:["groupid","contentid"],data:function(){return{id:null,loading:!0,filter:null,group:null,items:[],selectedItem:null}},computed:{filteredItems:function(){if(!this.filter||""===this.filter)return this.items;var e=this.filter.toLowerCase();return this.items.filter(function(t){return-1!==t.title.toLowerCase().indexOf(e)})}},methods:{load:function(){self=this,self.loading=!0,null===this.id&&(this.id=this.contentid);var e="";e=null!==this.id?piranha.baseUrl+"manager/api/content/"+this.id+"/listbyid":piranha.baseUrl+"manager/api/content/"+this.groupid+"/list",fetch(e).then(function(e){return e.json()}).then(function(e){self.group=e.group,self.items=e.items.map(function(t){var i=e.types.find(function(e){return e.id===t.typeId});return t.type=i.title||t.typeId,t.id===self.id&&(self.selectedItem=t),t}),self.loading=!1}).catch(function(e){console.log("error:",e)})},select:function(e){history.pushState({id:e.id},"",piranha.baseUrl+"manager/content/edit/"+e.id),piranha.content.load("content",e.id),this.selectedItem=e},onSaved:function(){this.id=piranha.content.id,this.load()}},mounted:function(){this.load(),this.eventBus.$on("onSaved",this.onSaved)},beforeDestroy:function(){this.eventBus.$off("onSaved")},template:'\n<div class="col side-nav">\n    <ul class="list-group list-group-flush list-content app" :class="{ ready: !loading }">\n        <li class="list-group-item header">\n            <div class="input-group">\n                <input v-model="filter" type="text" class="form-control" :placeholder="piranha.resources.texts.search">\n                <div class="input-group-append">\n                    <button class="btn btn-primary btn-icon">\n                        <i class="fas fa-plus"></i>\n                    </button>\n                </div>\n            </div>\n        </li>\n        <li v-for="item in filteredItems" v-bind:key="item.id" class="list-group-item" :class="{ active: item === selectedItem}">\n            <a v-on:click.prevent="select(item)" href="#">\n                <img v-if="group.listImage" class="float-left" :src="piranha.utils.formatUrl(item.imageUrl)" :alt="item.title">\n                <span>{{ item.title }}</span>\n                <span>{{ item.type }}</span>\n            </a>\n        </li>\n    </ul>\n</div>\n'}),piranha.content=new Vue({el:"#content",data:{contentType:null,onSave:null,prevId:null,features:{useAltTitle:!1,useBlocks:!1,useCategory:!1,useComments:!1,usePrimaryImage:!1,useExcerpt:!1,useHtmlExcerpt:!1,usePublish:!1,useTags:!1,useTranslations:!1},id:null,languageId:null,languageTitle:null,parentId:null,typeId:null,typeTitle:null,groupId:null,groupTitle:null,position:null,meta:null,comments:null,permissions:{selectedPermissions:[],permissions:[]},routes:null,taxonomies:null,title:null,altTitle:null,slug:null,primaryImage:null,excerpt:null,state:null,isReadOnly:!1,isScheduled:!1,published:null,publishedTime:null,blocks:[],editors:[],regions:[],languages:[],sections:[],loading:!0,saving:!1,savingDraft:!1,selectedRegion:"",selectedSetting:"uid-settings"},computed:{contentRegions:function(){return this.regions.filter(function(e){return"setting"!=e.meta.display&&"hidden"!=e.meta.display})},settingRegions:function(){return this.regions.filter(function(e){return"setting"===e.meta.display})},primaryImageUrl:function(){return null!=this.primaryImage.media?piranha.utils.formatUrl("~/manager/api/media/url/"+this.primaryImage.id+"/448/200"):piranha.utils.formatUrl("~/manager/assets/img/empty-image.png")},isExcerptEmpty:function(){return piranha.utils.isEmptyText(this.excerpt)},isPreviewActive:function(){return!this.features.useBlocks&&0===this.regions.length&&0===this.editors.length},isSettingsActive:function(){return!this.isPreviewActive||null!==this.meta||this.features.usePublish||this.features.useAltTitle},metaPriorityDescription:function(){var e=piranha.resources.texts.important;return this.metaPriority<=.3?e=piranha.resources.texts.low:this.metaPriority<=.6?e=piranha.resources.texts.medium:this.metaPriority<=.9&&(e=piranha.resources.texts.high),e+" ("+this.metaPriority+")"}},methods:{reset:function(e){this.contentType=e,this.features.useAltTitle=!1,this.features.useBlocks=!1,this.features.useCategory=!1,this.features.useComments=!1,this.features.usePrimaryImage=!1,this.features.useExcerpt=!1,this.features.useHtmlExcerpt=!1,this.features.usePublish=!1,this.features.useTags=!1,this.features.useTranslations=!1,this.id=null,this.languageId=null,this.languageTitle=null,this.parentId=null,this.typeId=null,this.typeTitle=null,this.groupId=null,this.groupTitle=null,this.position=null,this.meta=null,this.comments=null,this.permissions=null,this.routes=null,this.taxonomies=null,this.title=null,this.altTitle=null,this.slug=null,this.primaryImage=null,this.excerpt=null,this.state=null,this.isReadOnly=!1,this.isScheduled=!1,this.published=null,this.publishedTime=null,this.editors=[],this.regions=[],this.languages=[],this.sections=[]},bind:function(e){var t=this;this.features.useAltTitle=e.features.useAltTitle,this.features.useBlocks=e.features.useBlocks,this.features.useCategory=e.features.useCategory,this.features.useComments=e.features.useComments,this.features.usePrimaryImage=e.features.usePrimaryImage,this.features.useExcerpt=e.features.useExcerpt,this.features.useHtmlExcerpt=e.features.useHtmlExcerpt,this.features.usePublish=e.features.usePublish,this.features.useTags=e.features.useTags,this.features.useTranslations=e.features.useTranslations,this.id=e.id,this.languageId=e.languageId,this.languageTitle=e.languageTitle,this.parentId=e.parentId,this.typeId=e.typeId,this.typeTitle=e.typeTitle,this.groupId=e.groupId,this.groupTitle=e.groupTitle,this.position=e.position,this.meta=e.meta,this.comments=e.comments,this.permissions=e.permissions,this.routes=e.routes,this.taxonomies=e.taxonomies,this.title=e.title,this.altTitle=e.altTitle,this.slug=e.slug,this.primaryImage=e.primaryImage,this.excerpt=e.excerpt,this.state=e.state,this.isReadOnly=e.isReadOnly,this.isScheduled=e.isScheduled,this.published=e.published,this.publishedTime=e.publishedTime,this.editors=e.editors,this.regions=e.regions,this.languages=e.languages,this.sections=e.sections,null!==this.prevId&&this.prevId===this.id||(0===this.sections.length?this.editors.length>0?this.selectedRegion=this.editors[0]:this.contentRegions.length>0&&(this.selectedRegion=this.contentRegions[0].meta):this.selectedRegion={uid:this.sections[0].uid,name:null,icon:null}),this.prevId=this.id,Vue.nextTick(function(){t.features.useCategory&&($("#selectedCategory").select2({tags:!0,selectOnClose:!0,placeholder:piranha.resources.texts.addCategory}),$("#selectedCategory").on("change",function(){var e=$(this).find("option:selected").text();t.taxonomies.selectedCategory=e})),t.features.useTags&&($("#selectedTags").select2({tags:!0,selectOnClose:!1,placeholder:piranha.resources.texts.addTags}),$("#selectedTags").on("change",function(){var e=$(this).find("option:selected");t.taxonomies.selectedTags=[];for(var i=0;i<e.length;i++)t.taxonomies.selectedTags.push(e[i].text)})),t.loading=!1})},load:function(e,t,i){var s=this;this.loading=!0,this.contentType=e;var n=piranha.baseUrl+"manager/api/labs/"+s.contentType+"/"+t;null!=i&&(n+="/"+i),fetch(n).then(function(e){return e.json()}).then(function(t){s.reset(e),s.bind(t)}).catch(function(e){console.log("error:",e)})},save:function(){this.saving=!0,this.saveInternal(piranha.baseUrl+"manager/api/labs/"+this.contentType)},saveDraft:function(){this.savingDraft=!0,this.saveInternal(piranha.baseUrl+"manager/api/labs/"+this.contentType+"/draft")},revert:function(){var e=this;e.savingDraft=!0,fetch(piranha.baseUrl+"manager/api/labs/"+this.contentType+"/revert",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.id)}).then(function(e){return e.json()}).then(function(t){e.bind(t),piranha.notifications.push(t.status),e.saving=!1,e.savingDraft=!1,e.eventBus.$emit("onSaved",e.state)}).catch(function(e){console.log("error:",e)})},unpublish:function(){var e=this;e.saving=!0,fetch(piranha.baseUrl+"manager/api/labs/"+this.contentType+"/unpublish",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.id)}).then(function(e){return e.json()}).then(function(t){e.bind(t),e.saving=!1,e.savingDraft=!1,e.eventBus.$emit("onSaved",e.state)}).catch(function(e){console.log("error:",e)})},saveInternal:function(e){var t=this,i={id:t.id,languageId:t.languageId,parentId:t.parentId,typeId:t.typeId,groupId:t.groupId,position:JSON.parse(JSON.stringify(t.position)),meta:JSON.parse(JSON.stringify(t.meta)),comments:JSON.parse(JSON.stringify(t.comments)),permissions:{selectedPermissions:null!==t.permissions?t.permissions.selectedPermissions:[]},routes:JSON.parse(JSON.stringify(t.routes)),taxonomies:JSON.parse(JSON.stringify(t.taxonomies)),title:t.title,altTitle:t.altTitle,slug:t.slug,primaryImage:{id:t.primaryImage.id},excerpt:t.excerpt,published:t.published,publishedTime:t.publishedTime,regions:JSON.parse(JSON.stringify(t.regions)),sections:JSON.parse(JSON.stringify(t.sections))};fetch(e,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(function(e){return e.json()}).then(function(e){t.bind(e),piranha.notifications.push(e.status),t.saving=!1,t.savingDraft=!1,t.eventBus.$emit("onSaved",t.state)}).catch(function(e){console.log("error:",e)})},create:function(e,t){var i=this;fetch(piranha.baseUrl+"manager/api/"+i.contentType+"/create/"+e+"/"+pageType).then(function(e){return e.json()}).then(function(e){i.bind(e)}).catch(function(e){console.log("error:",e)})},remove:function(){self=this,piranha.alert.open({title:piranha.resources.texts.delete,body:'Are you sure you want to delete "'+self.title+'"',confirmCss:"btn-danger",confirmIcon:"fas fa-trash",confirmText:piranha.resources.texts.delete,onConfirm:function(){self.loading=!0,fetch(piranha.baseUrl+"manager/api/labs/"+self.contentType,{method:"delete",headers:{"Content-Type":"application/json"},body:JSON.stringify(self.id)}).then(function(e){return e.json()}).then(function(e){piranha.notifications.push(e),self.reset(),self.eventBus.$emit("onSaved",self.state)}).catch(function(e){console.log("error:",e)})}})},selectRegion:function(e){this.selectedRegion=e,Vue.nextTick(function(){piranha.editor.refreshMarkdown()})},selectSetting:function(e){this.selectedSetting=e,Vue.nextTick(function(){piranha.editor.refreshMarkdown()})},selectPrimaryImage:function(){null!==this.primaryImage.media?piranha.mediapicker.open(this.updatePrimaryImage,"Image",this.primaryImage.media.folderId):piranha.mediapicker.openCurrentFolder(this.updatePrimaryImage,"Image")},removePrimaryImage:function(){this.primaryImage.id=null,this.primaryImage.media=null},updatePrimaryImage:function(e){"Image"===e.type?(this.primaryImage.id=e.id,this.primaryImage.media=e):console.log("No image was selected")},onExcerptBlur:function(e){this.features.useHtmlExcerpt?this.excerpt=tinyMCE.activeEditor.getContent():this.excerpt=e.target.innerHTML},commentsClosedDate:function(){var e=new Date(this.published);return(e=e.addDays(this.comments.closeCommentsAfterDays)).toDateString()}},components:{datepicker:vuejsDatepicker}});